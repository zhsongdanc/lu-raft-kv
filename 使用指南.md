# Lu-Raft-KV 使用指南

## 快速开始

### 1. 环境准备

确保你的环境已安装：
- Java 8 或更高版本
- Maven 3.x
- IDE（推荐 IntelliJ IDEA）

### 2. 编译项目

```bash
cd lu-raft-kv
mvn clean compile
```

### 3. 启动集群

#### 方法一：使用IDE启动（推荐）

在 IntelliJ IDEA 中配置5个启动配置：

1. **启动配置1**：
   - Main class: `cn.think.in.java.RaftNodeBootStrap`
   - VM options: `-DserverPort=8775`

2. **启动配置2**：
   - Main class: `cn.think.in.java.RaftNodeBootStrap`
   - VM options: `-DserverPort=8776`

3. **启动配置3**：
   - Main class: `cn.think.in.java.RaftNodeBootStrap`
   - VM options: `-DserverPort=8777`

4. **启动配置4**：
   - Main class: `cn.think.in.java.RaftNodeBootStrap`
   - VM options: `-DserverPort=8778`

5. **启动配置5**：
   - Main class: `cn.think.in.java.RaftNodeBootStrap`
   - VM options: `-DserverPort=8779`

依次启动这5个配置，观察控制台输出。

#### 方法二：命令行启动

```bash
# 启动5个节点
java -cp target/classes -DserverPort=8775 cn.think.in.java.RaftNodeBootStrap &
java -cp target/classes -DserverPort=8776 cn.think.in.java.RaftNodeBootStrap &
java -cp target/classes -DserverPort=8777 cn.think.in.java.RaftNodeBootStrap &
java -cp target/classes -DserverPort=8778 cn.think.in.java.RaftNodeBootStrap &
java -cp target/classes -DserverPort=8779 cn.think.in.java.RaftNodeBootStrap &
```

### 4. 测试客户端

启动命令行客户端：

```bash
java -cp target/classes raft.client.RaftClientWithCommandLine
```

客户端支持的命令：
- `put <key> <value>` - 存储键值对
- `get <key>` - 获取值
- `exit` - 退出客户端

示例：
```
put name zhangsan
get name
put age 25
get age
exit
```

## 测试场景

### 1. Leader选举测试

1. 启动5个节点
2. 观察控制台，约6秒后会发生选举
3. 找到被选为Leader的节点
4. 关闭Leader节点
5. 观察剩余节点重新选举新Leader的过程

### 2. 日志复制测试

1. 启动5个节点，等待选举完成
2. 使用客户端写入一些数据：
   ```
   put key1 value1
   put key2 value2
   put key3 value3
   ```
3. 关闭所有节点
4. 使用测试类验证数据一致性：
   ```bash
   mvn test -Dtest=DefaultStateMachineTest
   ```

### 3. 故障恢复测试

1. 启动5个节点，等待选举完成
2. 使用客户端写入数据
3. 关闭Leader节点
4. 继续写入数据（会转发给新Leader）
5. 重启之前的Leader节点
6. 验证所有数据的一致性

## 监控和调试

### 1. 日志级别

在 `src/main/resources/log4j.xml` 中可以调整日志级别：

```xml
<logger name="cn.think.in.java" level="INFO"/>
```

### 2. 关键日志信息

- **选举日志**：`node will become CANDIDATE and start election leader`
- **心跳日志**：`append heartbeat success`
- **日志复制**：`append follower entry success`
- **状态变更**：`become leader` 或 `become FOLLOWER`

### 3. 性能监控

观察以下指标：
- 选举时间：正常情况下6-15秒
- 心跳间隔：500ms
- 日志复制延迟：取决于网络和磁盘性能

## 常见问题

### 1. 节点无法启动

**问题**：端口被占用
**解决**：检查端口是否被其他进程占用，或修改端口号

### 2. 选举失败

**问题**：网络分区或节点启动顺序问题
**解决**：确保所有节点能够相互通信，按顺序启动节点

### 3. 数据不一致

**问题**：网络延迟或节点故障
**解决**：检查网络连接，确保多数节点正常运行

### 4. 客户端连接失败

**问题**：Leader节点不可用
**解决**：等待新Leader选举完成，或重启集群

## 扩展开发

### 1. 添加新的状态机

实现 `StateMachine` 接口：

```java
public class CustomStateMachine implements StateMachine {
    @Override
    public void apply(LogEntry logEntry) {
        // 实现自定义逻辑
    }
    // 实现其他方法...
}
```

### 2. 自定义RPC协议

修改 `RpcService` 和 `RpcClient` 实现，支持不同的网络协议。

### 3. 添加监控指标

在关键位置添加监控代码，收集性能指标。

## 学习建议

1. **先理解Raft论文**：建议先阅读Raft论文，理解基本概念
2. **从简单场景开始**：先测试3个节点的集群
3. **观察日志输出**：通过日志理解Raft协议的运行过程
4. **逐步增加复杂度**：从正常情况到故障情况
5. **阅读源码**：重点关注 `DefaultNode` 和 `DefaultConsensus` 类

## 参考资料

- [Raft论文](https://raft.github.io/raft.pdf)
- [Raft算法动画演示](https://raft.github.io/)
- [项目GitHub地址](https://github.com/stateis0/lu-raft-kv)

